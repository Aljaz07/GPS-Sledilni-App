<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Sledenje</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
    }
    body.dark-mode {
      background: #222;
      color: white;
    }

    /* Prijavni zaslon - fullscreen ozadje */
    #login-container {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1470&q=80') no-repeat center center/cover;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      padding: 20px;
    }
    #login-box {
      background: rgba(0, 0, 0, 0.6);
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
      width: 100%;
      max-width: 400px;
      color: white;
      box-sizing: border-box;
    }
    #login-box h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-weight: 700;
      text-align: center;
    }

    /* Obrazci */
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    input[type=text], input[type=password] {
      padding: 10px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      outline: none;
      box-sizing: border-box;
    }
    input[type=text]:focus, input[type=password]:focus {
      box-shadow: 0 0 8px #00aaff;
    }
    button {
      padding: 12px;
      font-size: 1.1rem;
      background-color: #00aaff;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0077cc;
    }

    /* Prilagoditve za manjÅ¡e zaslone */
    @media (max-width: 480px) {
      #login-box {
        padding: 25px 20px;
        max-width: 100%;
      }
      button {
        font-size: 1rem;
        padding: 10px;
      }
    }

    /* Glavni del po prijavi */
    #main {
      display: none;
      height: 100vh;
      width: 100vw;
      flex-direction: column;
    }

    #map {
      flex-grow: 1;
    }

    /* Statistika na spodnjem levem kotu */
    #stats-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      border-radius: 12px;
      padding: 15px;
      color: #00aaff;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      box-shadow: 0 0 10px #00aaff;
      user-select: none;
      max-width: 260px;
      z-index: 1000;
    }

    /* Avatar styling */
    #avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      border: 2px solid #00aaff;
      margin-left: 15px;
    }

    /* Tooltip */
    [data-tooltip] {
      position: relative;
      cursor: pointer;
    }
    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #00aaff;
      color: black;
      padding: 5px 8px;
      border-radius: 6px;
      white-space: nowrap;
      font-size: 0.75rem;
      pointer-events: none;
      opacity: 0.9;
      margin-bottom: 5px;
      z-index: 9999;
    }

    /* Modal zgodovine voÅ¾enj */
    #ride-history-modal {
      display: none;
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.8);
      color: white;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #ride-history-modal > div {
      background: #111;
      padding: 20px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    #ride-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #ride-list li {
      margin-bottom: 12px;
      padding: 8px;
      background: #222;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #ride-list li:hover {
      background: #00aaff;
      color: black;
    }
    #close-modal {
      cursor: pointer;
      color: #00aaff;
      font-weight: bold;
      text-align: right;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <!-- PRIJAVA - fullscreen ozadje -->
  <div id="login-container">
    <div id="login-box">
      <h2>Prijava</h2>
      <form id="login-form">
        <input type="text" id="login-username" placeholder="UporabniÅ¡ko ime" required autocomplete="username" />
        <input type="password" id="login-password" placeholder="Geslo" required autocomplete="current-password" />
        <button type="submit" data-tooltip="Prijavite se v aplikacijo">ğŸ”‘ Prijava</button>
      </form>
      <hr style="margin: 20px 0; border-color: #00aaff;">
      <p style="text-align:center; margin:0 0 10px 0;">Nimate raÄuna?</p>
      <button id="show-register" data-tooltip="Registrirajte novega uporabnika" style="width: 100%;">ğŸ“ Registracija</button>
    </div>
  </div>

  <!-- REGISTRACIJA MODAL -->
  <div id="register-modal" style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background: rgba(0,0,0,0.85); z-index:15; display:flex; justify-content:center; align-items:center;">
    <div style="background: rgba(0,0,0,0.8); padding: 30px 40px; border-radius: 12px; max-width: 400px; width: 90%; box-sizing:border-box; color: white;">
      <h2>Registracija</h2>
      <form id="register-form">
        <input type="text" id="register-username" placeholder="UporabniÅ¡ko ime" required autocomplete="username" />
        <input type="password" id="register-password" placeholder="Geslo" required autocomplete="new-password" />
        <button type="submit" data-tooltip="Ustvarite nov raÄun">âœ… Registriraj</button>
      </form>
      <button id="close-register" style="margin-top: 15px; width: 100%; background: #cc0000;" data-tooltip="Zapri registracijo">âœ– Zapri</button>
    </div>
  </div>

  <!-- GLAVNI UI -->
  <div id="main">
    <div style="display:flex; align-items:center; padding: 10px; background:#000; box-shadow: 0 2px 10px rgba(0,0,0,0.8);">
      <button id="toggle-theme" data-tooltip="Preklop teme ğŸŒ™" style="background:#00aaff; border:none; border-radius:6px; color:#000; font-weight:bold; padding:8px 12px; cursor:pointer;">ğŸŒ™ Tema</button>
      <div id="avatar" data-tooltip="VaÅ¡ profil (klik za zgodovino)"></div>
      <input type="file" id="avatar-input" accept="image/*" style="display:none;" />
    </div>
    <div id="map" style="height: calc(100vh - 50px);"></div>

    <!-- Statistika v spodnjem levem kotu -->
    <div id="stats-panel">
      <div>â± ÄŒas: <span id="stat-time">0s</span></div>
      <div>ğŸ“ Razdalja: <span id="stat-distance">0 m</span></div>
      <div>ğŸš€ Povp. hitrost: <span id="stat-avgSpeed">0 km/h</span></div>
      <div>âš¡ Trenutna hitrost: <span id="stat-speed">0 km/h</span></div>
      <div>â›° ViÅ¡ina: <span id="stat-altitude">-</span></div>
      <div>ğŸŒ DrÅ¾ava: <span id="country">-</span></div>
      <div>ğŸ“ Lokacija: <span id="location">-</span></div>
      <div>ğŸ”‹ Napredek: <span id="progress">0%</span></div>
    </div>

    <!-- Gumbi za zaÄetek in konec voÅ¾nje -->
    <div style="position: fixed; bottom: 20px; right: 20px; display: flex; gap: 15px; z-index: 1100;">
      <button id="start-ride" data-tooltip="ZaÄni voÅ¾njo ğŸš´" style="background:#00aa00; border:none; border-radius: 8px; padding: 14px 18px; font-weight:bold; color:white; cursor:pointer;">ğŸš´ ZaÄni</button>
      <button id="stop-ride" data-tooltip="Ustavi voÅ¾njo âœ‹" style="background:#cc0000; border:none; border-radius: 8px; padding: 14px 18px; font-weight:bold; color:white; cursor:pointer;" disabled>âœ‹ Ustavi</button>
    </div>
  </div>

  <!-- Modal za zgodovino voÅ¾enj -->
  <div id="ride-history-modal">
    <div>
      <div id="close-modal">âœ– Zapri</div>
      <h3>Zgodovina voÅ¾enj</h3>
      <ul id="ride-list"></ul>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ---------- GLOBAL VARIABLES ----------
    let map, pathLine, markerGroup;
    let watchId;
    let rideStarted = false;
    let ridePath = [];
    let rideStartTime;
    let rideDistance = 0;
    let lastPosition = null;

    // Uporabnik (lokalno shranjeno)
    let user = {
      username: null,
      avatar: null,
      rides: []
    };

    // ------------ HELPER FUNCTIONS ------------
    function saveUserData(username, data) {
      const saved = JSON.parse(localStorage.getItem('gps_users') || '{}');
      saved[username] = {...(saved[username] || {}), ...data};
      localStorage.setItem('gps_users', JSON.stringify(saved));
    }

    function loadUserData(username) {
      const saved = JSON.parse(localStorage.getItem('gps_users') || '{}');
      return saved[username] || null;
    }

    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      return (hrs > 0 ? hrs + 'h ' : '') + (mins > 0 ? mins + 'm ' : '') + secs + 's';
    }

    // ------------ MAP INITIALIZATION ------------
    function initMap() {
      if (map) {
        map.remove();
      }

      const tileLayer = window.darkMode
        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

      map = L.map('map').setView([46.0569, 14.5058], 13);
      L.tileLayer(tileLayer, {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      markerGroup = L.layerGroup().addTo(map);
    }

    // ------------ USER LOGIN/REGISTER ------------
    const loginContainer = document.getElementById('login-container');
    const mainUI = document.getElementById('main');

    const loginForm = document.getElementById('login-form');
    const registerModal = document.getElementById('register-modal');
    const registerForm = document.getElementById('register-form');
    const showRegisterBtn = document.getElementById('show-register');
    const closeRegisterBtn = document.getElementById('close-register');

    showRegisterBtn.addEventListener('click', () => {
      registerModal.style.display = 'flex';
    });
    closeRegisterBtn.addEventListener('click', () => {
      registerModal.style.display = 'none';
    });

    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;

      const savedUser = loadUserData(username);
      if (savedUser && savedUser.password === password) {
        user = {...savedUser, username};
        loginContainer.style.display = 'none';
        mainUI.style.display = 'flex';
        initMap();
        updateAvatar();
        updateStatsPanel();
        startGeolocationWatch();
      } else {
        alert('Nepravilno uporabniÅ¡ko ime ali geslo.');
      }
    });

    registerForm.addEventListener('submit', e => {
      e.preventDefault();
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value;

      if (loadUserData(username)) {
        alert('UporabniÅ¡ko ime Å¾e obstaja.');
        return;
      }
      saveUserData(username, {password, avatar: null, rides: []});
      alert('Registracija uspeÅ¡na. Prosimo, prijavite se.');
      registerModal.style.display = 'none';
    });

    // ------------ AVATAR ------------
    const avatarDiv = document.getElementById('avatar');
    const avatarInput = document.getElementById('avatar-input');

    avatarDiv.addEventListener('click', () => {
      showRideHistory();
    });

    avatarInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        user.avatar = event.target.result;
        saveUserData(user.username, {avatar: user.avatar});
        updateAvatar();
      };
      reader.readAsDataURL(file);
    });

    function updateAvatar() {
      if (user.avatar) {
        avatarDiv.style.backgroundImage = `url(${user.avatar})`;
      } else {
        avatarDiv.style.backgroundImage = 'url(https://i.pravatar.cc/48)';
      }
    }

    // ------------ GELOCATION & TRACKING ------------
    function startGeolocationWatch() {
      if (!navigator.geolocation) {
        alert('VaÅ¡a naprava ne podpira geolokacije.');
        return;
      }
      watchId = navigator.geolocation.watchPosition(onPositionUpdate, onPositionError, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 10000
      });
    }

    function stopGeolocationWatch() {
      if (watchId !== undefined) {
        navigator.geolocation.clearWatch(watchId);
        watchId = undefined;
      }
    }

    function onPositionUpdate(position) {
      const {latitude, longitude, speed, altitude} = position.coords;
      const latlng = [latitude, longitude];

      // Update map
      if (map) {
        map.setView(latlng, map.getZoom());
        if (rideStarted) {
          ridePath.push(latlng);
          if (ridePath.length > 1) {
            const last = ridePath[ridePath.length - 2];
            rideDistance += map.distance(last, latlng);
          }
          updateRidePath();
        }
        updateStats(speed, altitude);
        updateLocationInfo(latitude, longitude);
      }
    }

    function onPositionError(error) {
      console.warn('Geolocation error:', error.message);
    }

    function updateRidePath() {
      if (pathLine) {
        map.removeLayer(pathLine);
      }
      if (ridePath.length > 1) {
        pathLine = L.polyline(ridePath, {color: 'orange'}).addTo(map);
      }
    }

    // ------------ START/STOP VOÅ½NJE ------------
    const startBtn = document.getElementById('start-ride');
    const stopBtn = document.getElementById('stop-ride');

    startBtn.addEventListener('click', () => {
      if (rideStarted) return;
      rideStarted = true;
      rideStartTime = Date.now();
      ridePath = [];
      rideDistance = 0;
      lastPosition = null;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      updateStatsPanel(true);
    });

    stopBtn.addEventListener('click', () => {
      if (!rideStarted) return;
      rideStarted = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      saveRide();
      resetStatsPanel();
      updateRidePath();
    });

    // ------------ STATISTIKA ------------
    let elapsedSeconds = 0;
    let statsInterval;

    function updateStats(speed, altitude) {
      if (!rideStarted) return;
      elapsedSeconds = Math.floor((Date.now() - rideStartTime) / 1000);

      // Hitrost m/s v km/h
      const kmhSpeed = speed ? (speed * 3.6).toFixed(1) : '0';

      document.getElementById('stat-speed').textContent = kmhSpeed + ' km/h';
      document.getElementById('stat-altitude').textContent = altitude !== null ? altitude.toFixed(0) + ' m' : '-';
      document.getElementById('stat-distance').textContent = rideDistance.toFixed(0) + ' m';
      document.getElementById('stat-time').textContent = formatTime(elapsedSeconds);
      document.getElementById('stat-avgSpeed').textContent = (rideDistance / elapsedSeconds * 3.6).toFixed(1) + ' km/h';
    }

    function updateStatsPanel(reset=false) {
      if (reset) {
        elapsedSeconds = 0;
        rideDistance = 0;
        document.getElementById('stat-speed').textContent = '0 km/h';
        document.getElementById('stat-altitude').textContent = '-';
        document.getElementById('stat-distance').textContent = '0 m';
        document.getElementById('stat-time').textContent = '0s';
        document.getElementById('stat-avgSpeed').textContent = '0 km/h';
      }
    }

    function resetStatsPanel() {
      updateStatsPanel(true);
    }

    // ------------ LOKACIJA IN DRÅ½AVA (reverse geocode) ------------
    async function updateLocationInfo(lat, lon) {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        const data = await res.json();
        const country = data.address.country || '-';
        const road = data.address.road || '';
        const house = data.address.house_number || '';
        const location = (road + (house ? ' ' + house : '')).trim() || '-';

        document.getElementById('country').textContent = country;
        document.getElementById('location').textContent = location;

        // Posodobitev napredka (dummy primer, realno bi imel zemljevid prevoÅ¾enih delov)
        const progressPercent = (Math.random() * 0.5).toFixed(4);
        document.getElementById('progress').textContent = (progressPercent * 100).toFixed(2) + '%';
      } catch (e) {
        document.getElementById('country').textContent = '-';
        document.getElementById('location').textContent = '-';
        document.getElementById('progress').textContent = '0%';
      }
    }

    // ------------ SHRANJEVANJE VOÅ½NJE ------------
    function saveRide() {
      if (!user.rides) user.rides = [];
      const endTime = Date.now();
      const duration = (endTime - rideStartTime) / 1000;
      user.rides.push({
        startTime: rideStartTime,
        endTime,
        duration,
        distance: rideDistance,
        path: ridePath.slice()
      });
      saveUserData(user.username, {rides: user.rides});
    }

    // ------------ ZGODOVINA VOÅ½ENJ (modal) ------------
    const rideHistoryModal = document.getElementById('ride-history-modal');
    const rideList = document.getElementById('ride-list');
    const closeModalBtn = document.getElementById('close-modal');

    closeModalBtn.addEventListener('click', () => {
      rideHistoryModal.style.display = 'none';
      if (pathLine) {
        map.removeLayer(pathLine);
        pathLine = null;
      }
      markerGroup.clearLayers();
    });

    window.addEventListener('click', e => {
      if (e.target === rideHistoryModal) {
        rideHistoryModal.style.display = 'none';
        if (pathLine) {
          map.removeLayer(pathLine);
          pathLine = null;
        }
        markerGroup.clearLayers();
      }
    });

    function showRideHistory() {
      if (!user.rides || user.rides.length === 0) {
        alert('Ni shranjenih voÅ¾enj.');
        return;
      }
      rideList.innerHTML = '';
      user.rides.forEach((ride, idx) => {
        const item = document.createElement('li');
        const startDate = new Date(ride.startTime);
        item.textContent = `${startDate.toLocaleString()} - ${ride.distance.toFixed(0)} m, ${formatTime(ride.duration)}`;
        item.style.cursor = 'pointer';
        item.addEventListener('click', () => {
          showRideOnMap(ride);
          rideHistoryModal.style.display = 'none';
        });
        rideList.appendChild(item);
      });
      rideHistoryModal.style.display = 'flex';
    }

    function showRideOnMap(ride) {
      if (pathLine) {
        map.removeLayer(pathLine);
      }
      markerGroup.clearLayers();
      pathLine = L.polyline(ride.path, {color: 'blue'}).addTo(map);
      if (ride.path.length > 0) {
        markerGroup.addLayer(L.marker(ride.path[0]).bindPopup('ZaÄetek voÅ¾nje').openPopup());
        markerGroup.addLayer(L.marker(ride.path[ride.path.length - 1]).bindPopup('Konec voÅ¾nje').openPopup());
      }
      map.fitBounds(pathLine.getBounds());
    }
  </script>
</body>
</html>
