<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPS Sledilna Aplikacija – Raziskovanje sveta</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #fff;
      transition: background 0.3s ease;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-width: 350px;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    button {
      background: linear-gradient(145deg, #e0e0e0, #bababa);
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      cursor: pointer;
      box-shadow: 5px 5px 8px #a3a3a3,
                  -5px -5px 8px #ffffff;
      transition: all 0.3s ease;
      flex: 1 1 45%;
      min-width: 120px;
      text-align: center;
      user-select: none;
    }
    button:hover {
      box-shadow: inset 5px 5px 8px #a3a3a3,
                  inset -5px -5px 8px #ffffff;
      color: #000;
    }
    .progress, #point-count, #country {
      width: 100%;
      margin-top: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #555;
    }

    /* Temni način */
    body.dark-mode {
      background: #121212;
      color: #eee;
    }
    body.dark-mode .controls {
      background: #222;
      box-shadow: 0 6px 12px rgba(0,0,0,0.8);
      color: #eee;
    }
    body.dark-mode button {
      background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
      color: #ccc;
      box-shadow: 5px 5px 8px #0f0f0f,
                  -5px -5px 8px #3a3a3a;
    }
    body.dark-mode button:hover {
      box-shadow: inset 5px 5px 8px #0f0f0f,
                  inset -5px -5px 8px #3a3a3a;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button onclick="startTracking()">Začni sledenje</button>
    <button onclick="stopTracking()">Ustavi</button>
    <button onclick="clearTrack()">Počisti</button>
    <button onclick="exportPath()">Izvozi JSON</button>
    <button onclick="exportGeoJSON()">Izvozi GeoJSON</button>
    <button onclick="exportGPX()">Izvozi GPX</button>
    <button onclick="returnToCurrentLocation()">Moja lokacija</button>
    <button onclick="toggleDarkMode()">Preklopi temni način</button>
    <div id="progress" class="progress">Napredek: 0%</div>
    <div id="point-count">Točk: 0</div>
    <div id="country">Država: -</div>
  </div>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Zacetni sloji (svetli in temni)
      const lightModeLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
      });

      const darkModeLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      });

      // Inicializacija zemljevida s maxZoom
      const map = L.map("map", {
        center: [46.0569, 14.5058],
        zoom: 8,
        maxZoom: 18,
        layers: [lightModeLayer],
      });

      let path = [];
      let polyline = L.polyline(path, { color: "blue" }).addTo(map);
      let markers = L.markerClusterGroup();
      map.addLayer(markers);

      let visitedGrids = new Set();
      let totalGrids = 10000;
      let watchId = null;
      let countriesVisited = new Set();
      let countryGrids = {};

      // Avatar marker (ikona)
      const avatarIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/147/147144.png', // primer avatar ikone
        iconSize: [40, 40],
        iconAnchor: [20, 40], // da se "stoji" na lokaciji
      });
      let avatarMarker = L.marker([46.0569, 14.5058], { icon: avatarIcon }).addTo(map);

      function getGridId(lat, lng) {
        const latId = Math.floor(lat * 20);
        const lngId = Math.floor(lng * 20);
        return `${latId}_${lngId}`;
      }

      function findNearbyPOIs(lat, lng) {
        const pois = [
          { name: "Bencinski servis", lat: lat + 0.001, lng: lng + 0.001 },
          { name: "Trgovina", lat: lat - 0.001, lng: lng - 0.001 },
        ];
        pois.forEach(poi => {
          const marker = L.marker([poi.lat, poi.lng]).bindPopup(poi.name);
          markers.addLayer(marker);
        });
      }

      async function getCountry(lat, lng) {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`, {
            headers: {
              'User-Agent': 'WorldExplorerApp/1.0 (https://aljaz07.github.io)',
              'Referer': 'https://aljaz07.github.io'
            }
          });
          const data = await res.json();
          return data.address?.country || "Neznano";
        } catch (e) {
          return "Neznano";
        }
      }

      function updatePath(lat, lng) {
        const point = [lat, lng];
        path.push(point);
        polyline.setLatLngs(path);

        // Dodaj tudi marker na poti (majhen krog)
        const marker = L.circleMarker(point, { radius: 5, color: "blue" });
        markers.addLayer(marker);

        const gridId = getGridId(lat, lng);
        visitedGrids.add(gridId);

        const percent = ((visitedGrids.size / totalGrids) * 100).toFixed(2);
        document.getElementById("point-count").innerText = `Točk: ${path.length}`;

        findNearbyPOIs(lat, lng);

        getCountry(lat, lng).then((country) => {
          countriesVisited.add(country);
          document.getElementById("country").innerText = `Država: ${country}`;

          if (!countryGrids[country]) countryGrids[country] = new Set();
          countryGrids[country].add(gridId);

          let html = '';
          for (const c of countriesVisited) {
            const pct = ((countryGrids[c]?.size || 0) / totalGrids * 100).toFixed(2);
            html += `${c}: ${pct}%<br>`;
          }
          document.getElementById("progress").innerHTML = `Napredek:<br>${html}`;
        });
      }

      window.startTracking = function () {
        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            (pos) => {
              const { latitude, longitude } = pos.coords;
              // Posodobi avatarja
              avatarMarker.setLatLng([latitude, longitude]);
              // Premakni pogled
              map.setView([latitude, longitude], map.getZoom());
              updatePath(latitude, longitude);
            },
            (err) => alert("Napaka pri GPS: " + err.message),
            { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
          );
        } else {
          alert("Geolokacija ni podprta v tem brskalniku.");
        }
      };

      window.stopTracking = function () {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
      };

      window.clearTrack = function () {
        window.stopTracking();
        path = [];
        polyline.setLatLngs(path);
        markers.clearLayers();
        visitedGrids.clear();
        countriesVisited.clear();
        countryGrids = {};
        document.getElementById("progress").innerText = `Napredek: 0%`;
        document.getElementById("point-count").innerText = `Točk: 0`;
        document.getElementById("country").innerText = `Država: -`;
      };

      window.exportPath = function () {
        const blob = new Blob([
          JSON.stringify({ path, countries: Array.from(countriesVisited) }, null, 2)
        ], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'podatki-potovanja.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      window.exportGeoJSON = function () {
        const geojson = {
          type: "FeatureCollection",
          features: path.map(p => ({
            type: "Feature",
            geometry: { type: "Point", coordinates: [p[1], p[0]] },
            properties: {}
          }))
        };
        const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pot.geojson';
        a.click();
      };

      window.exportGPX = function () {
        let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n`;
        gpx += `<gpx version="1.1" creator="GPS Sledilna Aplikacija">\n<trk><name>Pot</name><trkseg>\n`;
        path.forEach(([lat, lng]) => {
          gpx += `<trkpt lat="${lat}" lon="${lng}"></trkpt>\n`;
        });
        gpx += `</trkseg></trk></gpx>`;
        const blob = new Blob([gpx], { type: "application/gpx+xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pot.gpx';
        a.click();
      };

      window.returnToCurrentLocation = function () {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const { latitude, longitude } = pos.coords;
              map.setView([latitude, longitude], 16);
              avatarMarker.setLatLng([latitude, longitude]);
            },
            (err) => alert("Napaka pri pridobivanju lokacije: " + err.message)
          );
        } else {
          alert("Geolokacija ni podprta v tem brskalniku.");
        }
      };

      let isDarkMode = false;
      window.toggleDarkMode = function () {
        if (isDarkMode) {
          map.removeLayer(darkModeLayer);
          lightModeLayer.addTo(map);
          document.body.classList.remove("dark-mode");
        } else {
          map.removeLayer(lightModeLayer);
          darkModeLayer.addTo(map);
          document.body.classList.add("dark-mode");
        }
        isDarkMode = !isDarkMode;
      };
    });
  </script>
</body>
</html>
