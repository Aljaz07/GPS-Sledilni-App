<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPS Sledilna Aplikacija – Raziskovanje sveta</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    /* Temni in svetli način */
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-color);
      color: var(--text-color);
      font-family: Arial, sans-serif;
      transition: background 0.3s, color 0.3s;
    }

    :root {
      --bg-color: #fff;
      --text-color: #000;
      --control-bg: #fff;
      --control-shadow: rgba(0,0,0,0.2);
      --button-bg: linear-gradient(145deg, #e0e0e0, #bababa);
      --button-shadow: 5px 5px 10px #a3a3a3, -5px -5px 10px #ffffff;
    }

    body.dark {
      --bg-color: #121212;
      --text-color: #eee;
      --control-bg: #1e1e1e;
      --control-shadow: rgba(0,0,0,0.7);
      --button-bg: linear-gradient(145deg, #2a2a2a, #1a1a1a);
      --button-shadow: 5px 5px 10px #171717, -5px -5px 10px #3a3a3a;
    }

    #map {
      flex-grow: 1;
      width: 100%;
      /* višina prilagojena flexu */
    }

    .controls {
      position: relative;
      padding: 10px;
      background: var(--control-bg);
      box-shadow: 0 2px 6px var(--control-shadow);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      z-index: 1000;
    }

    .controls button {
      cursor: pointer;
      padding: 10px 15px;
      border: none;
      border-radius: 12px;
      background: var(--button-bg);
      box-shadow: var(--button-shadow);
      color: var(--text-color);
      font-weight: 600;
      transition: all 0.2s ease;
      user-select: none;
      outline-offset: 2px;
    }

    .controls button:hover {
      filter: brightness(1.1);
      box-shadow: inset 2px 2px 5px #a9a9a9,
                  inset -2px -2px 5px #ffffff;
    }

    .controls button:active {
      transform: translateY(2px);
      box-shadow: inset 1px 1px 3px #00000066;
    }

    .progress, #point-count, #country {
      flex-grow: 1;
      font-size: 14px;
      user-select: none;
    }

    /* Gumb za temni način na desni */
    #darkModeToggle {
      margin-left: auto;
      background: #444;
      color: #eee;
      font-weight: bold;
    }

    /* Icon avatar style */
    .avatar-icon {
      border-radius: 50%;
      border: 3px solid #337ab7;
      background: url('https://cdn-icons-png.flaticon.com/512/194/194938.png') no-repeat center/cover;
      width: 40px;
      height: 40px;
      box-shadow: 0 0 8px rgba(51,122,183,0.7);
    }
  </style>
</head>
<body>
  <div class="controls">
    <button onclick="startTracking()">Začni sledenje</button>
    <button onclick="stopTracking()">Ustavi</button>
    <button onclick="clearTrack()">Počisti</button>
    <button onclick="exportPath()">Izvozi JSON</button>
    <button onclick="exportGeoJSON()">Izvozi GeoJSON</button>
    <button onclick="exportGPX()">Izvozi GPX</button>
    <button onclick="centerOnUser()">Pojdi na mojo lokacijo</button>
    <button id="darkModeToggle">Temni način</button>

    <div id="progress" class="progress">Napredek: 0%</div>
    <div id="point-count">Točk: 0</div>
    <div id="country">Država: -</div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const map = L.map("map", { maxZoom: 18 }).setView([46.0569, 14.5058], 8);

      // TileLayer (svetla privzeta)
      const lightTiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
      });

      // Temni tileLayer (CartoDB Dark Matter)
      const darkTiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        attribution: '&copy; <a href="https://carto.com/">CARTO</a>'
      });

      // Začnemo s svetlim načinom
      let isDarkMode = false;
      lightTiles.addTo(map);

      let path = [];
      let polyline = L.polyline(path, { color: "blue" }).addTo(map);
      let markers = L.markerClusterGroup();
      map.addLayer(markers);

      let visitedGrids = new Set();
      let totalGrids = 10000;
      let watchId = null;
      let countriesVisited = new Set();
      let countryGrids = {};

      // Avatar marker - posebna ikona
      const avatarIcon = L.divIcon({
        className: 'avatar-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 40]
      });
      let avatarMarker = null;

      function getGridId(lat, lng) {
        const latId = Math.floor(lat * 20);
        const lngId = Math.floor(lng * 20);
        return `${latId}_${lngId}`;
      }

      function findNearbyPOIs(lat, lng) {
        const pois = [
          { name: "Bencinski servis", lat: lat + 0.001, lng: lng + 0.001 },
          { name: "Trgovina", lat: lat - 0.001, lng: lng - 0.001 },
        ];
        pois.forEach(poi => {
          const marker = L.marker([poi.lat, poi.lng]).bindPopup(poi.name);
          markers.addLayer(marker);
        });
      }

      async function getCountry(lat, lng) {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
          const data = await res.json();
          return data.address.country;
        } catch (e) {
          return "Neznano";
        }
      }

      function updatePath(lat, lng) {
        const point = [lat, lng];
        path.push(point);
        polyline.setLatLngs(path);

        // Dodaj običajni marker
        const marker = L.circleMarker(point, { radius: 5, color: "blue" });
        markers.addLayer(marker);

        // Posodobi avatar marker (premakni ga)
        if (!avatarMarker) {
          avatarMarker = L.marker(point, { icon: avatarIcon }).addTo(map);
        } else {
          avatarMarker.setLatLng(point);
        }

        const gridId = getGridId(lat, lng);
        visitedGrids.add(gridId);

        const percent = ((visitedGrids.size / totalGrids) * 100).toFixed(2);
        document.getElementById("point-count").innerText = `Točk: ${path.length}`;

        findNearbyPOIs(lat, lng);

        getCountry(lat, lng).then((country) => {
          countriesVisited.add(country);
          document.getElementById("country").innerText = `Država: ${country}`;

          if (!countryGrids[country]) countryGrids[country] = new Set();
          countryGrids[country].add(gridId);

          let html = '';
          for (const c of countriesVisited) {
            const pct = ((countryGrids[c]?.size || 0) / totalGrids * 100).toFixed(2);
            html += `${c}: ${pct}%<br>`;
          }
          document.getElementById("progress").innerHTML = `Napredek:<br>${html}`;
        });
      }

      window.startTracking = function () {
        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            (pos) => {
              const { latitude, longitude } = pos.coords;
              map.setView([latitude, longitude], map.getZoom());
              updatePath(latitude, longitude);
            },
            (err) => alert("Napaka pri GPS: " + err.message),
            { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
          );
        } else {
          alert("Geolokacija ni podprta v
