<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS sledenje</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <style>
    /* Osnovni reset in layout */
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
      overflow: hidden;
    }

    /* Login container */
    #login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
      background-size: cover;
      flex-direction: column;
      padding: 20px;
    }

    #login-container form {
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 15px;
      width: 100%;
      max-width: 320px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #login-container input[type="text"],
    #login-container input[type="password"] {
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 1em;
    }

    #login-container button {
      background: #007acc;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      transition: background 0.3s ease;
    }

    #login-container button:hover {
      background: #005f99;
    }

    #login-container .link-button {
      background: none;
      border: none;
      color: #0af;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      font-size: 0.9em;
      margin-top: -10px;
      align-self: flex-start;
    }

    /* Register modal */
    #register-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1200;
    }

    #register-modal > div {
      background: #222;
      padding: 25px;
      border-radius: 15px;
      width: 100%;
      max-width: 350px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 15px;
      color: white;
    }

    #register-modal input {
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 1em;
    }

    #register-modal button {
      background: #28a745;
      border: none;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      font-size: 1em;
      transition: background 0.3s ease;
    }
    #register-modal button:hover {
      background: #1e7e34;
    }

    #close-register {
      cursor: pointer;
      align-self: flex-end;
      font-weight: bold;
      font-size: 1.3em;
      color: #eee;
      user-select: none;
    }

    /* Main UI */
    #main {
      display: none;
      height: 100%;
      position: relative;
      flex-direction: column;
      background: #121212;
    }

    /* Map */
    #map {
      height: 100%;
      width: 100%;
      filter: brightness(0.8);
    }

    /* Buttons start/stop */
    #controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 15px;
      z-index: 1100;
    }

    #controls button {
      background: #007700;
      border: none;
      border-radius: 8px;
      padding: 14px 18px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      font-size: 1.1em;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s ease;
    }
    #controls button:disabled {
      background: #555;
      cursor: default;
    }
    #controls button:hover:not(:disabled) {
      background: #005500;
    }

    #controls #stop-ride {
      background: #cc0000;
    }
    #controls #stop-ride:hover:not(:disabled) {
      background: #990000;
    }

    /* Statistika panel (3D stiliziran) */
    #stats-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(10, 10, 10, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px 20px;
      width: 250px;
      font-size: 0.9em;
      box-shadow:
        2px 2px 5px rgba(0, 0, 0, 0.8),
        inset 0 0 10px #00ff99;
      color: #00ff99;
      z-index: 1100;
      user-select: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #stats-panel div {
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      font-weight: 600;
    }

    /* Avatar */
    #avatar {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #222;
      background-size: cover;
      background-position: center center;
      border: 2px solid #00ff99;
      cursor: pointer;
      z-index: 1200;
      user-select: none;
    }

    /* Upload avatar hidden */
    #avatar-input {
      display: none;
    }

    /* Tooltip */
    [data-tooltip] {
      position: relative;
    }
    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: #00ff99;
      padding: 6px 10px;
      border-radius: 6px;
      white-space: nowrap;
      font-size: 0.85em;
      z-index: 1300;
      pointer-events: none;
      box-shadow: 0 0 6px #00ff99aa;
      opacity: 0.95;
    }

    /* Modal za zgodovino vo≈æenj */
    #ride-history-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1300;
      user-select: none;
    }
    #ride-history-modal > div {
      background: #111;
      padding: 25px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 80%;
      overflow-y: auto;
      box-sizing: border-box;
      color: #00ff99;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #ride-history-modal h3 {
      margin-top: 0;
      font-weight: 700;
      text-align: center;
    }
    #ride-list {
      list-style: none;
      padding: 0;
      margin: 10px 0 0 0;
    }
    #ride-list li {
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      background: #222;
      transition: background 0.2s ease;
      user-select: none;
    }
    #ride-list li:hover {
      background: #00ff99;
      color: #121212;
    }
    #close-modal {
      cursor: pointer;
      font-weight: bold;
      font-size: 1.3em;
      color: #00ff99;
      text-align: right;
      user-select: none;
      margin-bottom: 10px;
    }

    /* Responsive */
    @media (max-width: 480px) {
      #stats-panel {
        width: 90vw;
        bottom: 80px;
        left: 5vw;
      }
      #controls {
        bottom: 80px;
        right: 5vw;
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="login-container">
    <form id="login-form">
      <input id="login-username" type="text" placeholder="Uporabni≈°ko ime" autocomplete="username" required />
      <input id="login-password" type="password" placeholder="Geslo" autocomplete="current-password" required />
      <button type="submit" data-tooltip="Prijava">Prijava üîë</button>
      <button type="button" id="show-register" class="link-button" data-tooltip="Ustvari nov raƒçun">Registracija üìù</button>
    </form>
  </div>

  <!-- Register Modal -->
  <div id="register-modal">
    <div>
      <div id="close-register" data-tooltip="Zapri modal">‚úñ</div>
      <form id="register-form">
        <input id="register-username" type="text" placeholder="Uporabni≈°ko ime" autocomplete="username" required />
        <input id="register-password" type="password" placeholder="Geslo" autocomplete="new-password" required />
        <button type="submit" data-tooltip="Ustvari raƒçun">Registriraj</button>
      </form>
    </div>
  </div>

  <!-- Main UI -->
  <div id="main">
    <div id="map"></div>

    <div id="controls">
      <button id="start-ride" data-tooltip="Zaƒçni vo≈ænjo">‚ñ∂Ô∏è Zaƒçni</button>
      <button id="stop-ride" data-tooltip="Ustavi vo≈ænjo" disabled>‚èπÔ∏è Ustavi</button>
    </div>

    <div id="stats-panel">
      <div>Hitrost: <span id="speed">0</span> km/h</div>
      <div>Vi≈°ina: <span id="altitude">0</span> m</div>
      <div>Razdalja: <span id="distance">0</span> m</div>
      <div>ƒåas: <span id="time">00:00:00</span></div>
      <div>Povpreƒçna hitrost: <span id="avgSpeed">0</span> km/h</div>
      <div>Dr≈æava: <span id="country">-</span></div>
      <div>Lokacija: <span id="location">-</span></div>
      <div>Raziskano: <span id="progress">0%</span></div>
    </div>

    <div id="avatar" title="Klikni za ogled zgodovine vo≈æenj"></div>
    <input type="file" id="avatar-input" accept="image/*" title="Nalo≈æi profilno sliko" />

  </div>

  <!-- Modal zgodovine vo≈æenj -->
  <div id="ride-history-modal">
    <div>
      <div id="close-modal" data-tooltip="Zapri zgodovino">‚úñ</div>
      <h3>Zgodovina vo≈æenj</h3>
      <ul id="ride-list"></ul>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet/dist/leaflet.js"
  ></script>
  <script>
    // --- Globalne spremenljivke ---
    let map;
    let markerGroup;
    let pathLine;
    let watchId = null;

    let rideStarted = false;
    let rideStartTime = null;
    let rideDistance = 0;
    let lastPosition = null;
    let ridePath = [];

    let rides = JSON.parse(localStorage.getItem('rides') || '[]');

    let userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');

    // --- ELEMENTI ---
    const loginContainer = document.getElementById('login-container');
    const loginForm = document.getElementById('login-form');
    const registerModal = document.getElementById('register-modal');
    const registerForm = document.getElementById('register-form');
    const mainUI = document.getElementById('main');
    const startBtn = document.getElementById('start-ride');
    const stopBtn = document.getElementById('stop-ride');
    const statsPanel = document.getElementById('stats-panel');
    const speedSpan = document.getElementById('speed');
    const altitudeSpan = document.getElementById('altitude');
    const distanceSpan = document.getElementById('distance');
    const timeSpan = document.getElementById('time');
    const avgSpeedSpan = document.getElementById('avgSpeed');
    const countrySpan = document.getElementById('country');
    const locationSpan = document.getElementById('location');
    const progressSpan = document.getElementById('progress');
    const avatarDiv = document.getElementById('avatar');
    const avatarInput = document.getElementById('avatar-input');
    const rideHistoryModal = document.getElementById('ride-history-modal');
    const rideList = document.getElementById('ride-list');
    const closeModalBtn = document.getElementById('close-modal');
    const showRegisterBtn = document.getElementById('show-register');
    const closeRegisterBtn = document.getElementById('close-register');

    // --- Funkcije za prijavo/registracijo ---
    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      // POENOSTAVLJENA prijava
      const username = document.getElementById('login-username').value.trim();
      if (!username) return alert('Vpi≈°i uporabni≈°ko ime');
      userProfile.username = username;
      localStorage.setItem('userProfile', JSON.stringify(userProfile));
      loginContainer.style.display = 'none';
      mainUI.style.display = 'flex';
      initMap();
      loadAvatar();
      updateStatsPanel();
    });

    showRegisterBtn.addEventListener('click', () => {
      registerModal.style.display = 'flex';
    });

    closeRegisterBtn.addEventListener('click', () => {
      registerModal.style.display = 'none';
    });

    registerForm.addEventListener('submit', e => {
      e.preventDefault();
      alert('Registracija ni implementirana, prijavi se kar s poljubnim imenom :)');
      registerModal.style.display = 'none';
    });

    // --- Avatar upload ---
    avatarDiv.addEventListener('click', () => {
      avatarInput.click();
    });

    avatarInput.addEventListener('change', () => {
      const file = avatarInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        userProfile.avatar = reader.result;
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        loadAvatar();
      };
      reader.readAsDataURL(file);
    });

    function loadAvatar() {
      if (userProfile.avatar) {
        avatarDiv.style.backgroundImage = `url(${userProfile.avatar})`;
      } else {
        avatarDiv.style.backgroundImage = 'url(https://cdn-icons-png.flaticon.com/512/149/149071.png)';
      }
    }

    // --- Zemljevid ---
    function initMap() {
      if (map) {
        map.remove();
      }
      map = L.map('map', {zoomControl: true, scrollWheelZoom: true, tap: false});
      markerGroup = L.layerGroup().addTo(map);
      pathLine = null;

      // Dark map tiles
      L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        {
          attribution:
            '&copy; <a href="https://carto.com/">CARTO</a> contributors',
          maxZoom: 19,
        }
      ).addTo(map);

      // Poskusi dobiti lokacijo in nastavi view
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const latlng = [position.coords.latitude, position.coords.longitude];
            map.setView(latlng, 15);
            markerGroup.clearLayers();
            markerGroup.addLayer(L.marker(latlng).bindPopup('Trenutna lokacija').openPopup());
          },
          () => {
            map.setView([46.0569, 14.5058], 8); // Ljubljana default
          }
        );
      } else {
        map.setView([46.0569, 14.5058], 8);
      }
    }

    // --- Sledenje vo≈ænji ---
    startBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolokacija ni podprta v tvojem brskalniku.');
        return;
      }
      rideStarted = true;
      rideStartTime = Date.now();
      rideDistance = 0;
      lastPosition = null;
      ridePath = [];
      resetStats();
      updateStatsPanel();
      startBtn.disabled = true;
      stopBtn.disabled = false;

      watchId = navigator.geolocation.watchPosition(
        pos => {
          const {latitude, longitude, speed, altitude} = pos.coords;

          const currPos = [latitude, longitude];
          if (lastPosition) {
            const d = getDistanceFromLatLonInMeters(
              lastPosition[0],
              lastPosition[1],
              latitude,
              longitude
            );
            rideDistance += d;
          }
          lastPosition = currPos;
          ridePath.push(currPos);

          speedSpan.textContent = speed ? (speed * 3.6).toFixed(1) : '0'; // m/s -> km/h
          altitudeSpan.textContent = altitude ? altitude.toFixed(0) : '0';
          distanceSpan.textContent = rideDistance.toFixed(0);

          const elapsed = Date.now() - rideStartTime;
          timeSpan.textContent = formatTime(elapsed);

          const avgSpeed = rideDistance / (elapsed / 1000) * 3.6 || 0;
          avgSpeedSpan.textContent = avgSpeed.toFixed(1);

          // Posodobi lokacijo & dr≈æavo (simulirano)
          updateLocationAndCountry(latitude, longitude);

          // Posodobi path na zemljevidu
          updateMapPath(ridePath);
        },
        err => {
          console.error('Napaka pri pridobivanju lokacije:', err);
          alert('Napaka pri pridobivanju lokacije. Poskusi znova.');
          stopRide();
        },
        {enableHighAccuracy: true, maximumAge: 1000}
      );
    });

    stopBtn.addEventListener('click', () => {
      if (!rideStarted) return;
      stopRide();
    });

    function stopRide() {
      rideStarted = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;

      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      if (ridePath.length > 1) {
        // Shrani vo≈ænjo v zgodovino
        rides.push({
          startTime: rideStartTime,
          duration: Date.now() - rideStartTime,
          distance: rideDistance,
          path: ridePath,
        });
        localStorage.setItem('rides', JSON.stringify(rides));
        userProfile.rides = rides;
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
      }

      resetStats();
      updateStatsPanel();
      clearMapPath();
    }

    // --- Utility funkcije ---
    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Zemljin radij v metrih
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) *
          Math.cos(deg2rad(lat2)) *
          Math.sin(dLon / 2) *
          Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
    function deg2rad(deg) {
      return deg * (Math.PI / 180);
    }

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const h = Math.floor(totalSeconds / 3600)
        .toString()
        .padStart(2, '0');
      const m = Math.floor((totalSeconds % 3600) / 60)
        .toString()
        .padStart(2, '0');
      const s = (totalSeconds % 60).toString().padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    // Posodobi zemljevid pot
    function updateMapPath(path) {
      if (pathLine) {
        map.removeLayer(pathLine);
      }
      if (markerGroup) {
        markerGroup.clearLayers();
      }
      if (path.length > 0) {
        pathLine = L.polyline(path, { color: 'lime' }).addTo(map);
        // Markiraj zaƒçetek in konec
        markerGroup.addLayer(L.marker(path[0]).bindPopup('Zaƒçetek vo≈ænje').openPopup());
        markerGroup.addLayer(L.marker(path[path.length - 1]).bindPopup('Konec vo≈ænje').openPopup());
        map.fitBounds(pathLine.getBounds());
      }
    }

    function clearMapPath() {
      if (pathLine) {
        map.removeLayer(pathLine);
        pathLine = null;
      }
      if (markerGroup) {
        markerGroup.clearLayers();
      }
    }

    function resetStats() {
      speedSpan.textContent = '0';
      altitudeSpan.textContent = '0';
      distanceSpan.textContent = '0';
      timeSpan.textContent = '00:00:00';
      avgSpeedSpan.textContent = '0';
      progressSpan.textContent = '0%';
      countrySpan.textContent = '-';
      locationSpan.textContent = '-';
    }

    function updateStatsPanel() {
      if (userProfile.rides && userProfile.rides.length > 0) {
        const lastRide = userProfile.rides[userProfile.rides.length - 1];
        speedSpan.textContent = '0';
        altitudeSpan.textContent = '0';
        distanceSpan.textContent = lastRide.distance.toFixed(0);
        timeSpan.textContent = formatTime(lastRide.duration);
        avgSpeedSpan.textContent = (lastRide.distance / (lastRide.duration / 1000) * 3.6).toFixed(1);
        // Za lokacijo in dr≈æavo bi potrebovali API, tukaj je placeholder
        countrySpan.textContent = '-';
        locationSpan.textContent = '-';

        // Raziskano napredek (primer: razdalja / 10000m)
        let progressPercent = Math.min(100, (lastRide.distance / 10000) * 100);
        progressSpan.textContent = progressPercent.toFixed(0) + '%';
      } else {
        resetStats();
      }
    }

    function updateLocationAndCountry(lat, lon) {
      // Poenostavljeno, da ni API-ja
      locationSpan.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
      countrySpan.textContent = 'Slovenija';
    }

    // --- Zgodovina vo≈æenj ---
    avatarDiv.addEventListener('dblclick', () => {
      if (rides.length === 0) {
        alert('Ni zgodovine vo≈æenj.');
        return;
      }
      rideList.innerHTML = '';
      rides.forEach((ride, index) => {
        const li = document.createElement('li');
        li.textContent = `Vo≈ænja ${index + 1}: ${formatTime(ride.duration)}, razdalja: ${ride.distance.toFixed(0)} m`;
        li.addEventListener('click', () => {
          updateMapPath(ride.path);
          rideHistoryModal.style.display = 'flex';
        });
        rideList.appendChild(li);
      });
    });

    closeModalBtn.addEventListener('click', () => {
      rideHistoryModal.style.display = 'none';
      clearMapPath();
    });

    // --- Inicializacija ---
    if (localStorage.getItem('userProfile')) {
      loginContainer.style.display = 'none';
      mainUI.style.display = 'flex';
      initMap();
      loadAvatar();
      updateStatsPanel();
    }
  </script>
</body>
</html>
