<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Sledilna Aplikacija</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <style>
    /* Osnovni reset */
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Tema: temni naƒçin */
    body.dark-mode {
      background: #121212;
      color: #eee;
    }

    /* 3D-stilizirani naslovi */
    h1.fancy-3d-text, h2.fancy-3d-subtitle, h3.fancy-3d-subtitle {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow:
        1px 1px 1px rgba(0,0,0,0.15),
        2px 2px 2px rgba(0,0,0,0.1),
        3px 3px 3px rgba(0,0,0,0.05);
      font-weight: 900;
      user-select: none;
      margin: 0.25em 0;
    }

    /* Prijavni/registracijski container z ozadjem */
    #login-register-container {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      background: rgba(255 255 255 / 0.9);
      border-radius: 16px;
      box-shadow:
        0 8px 24px rgba(0,0,0,0.25),
        inset 0 0 30px rgba(255, 255, 255, 0.7);
      padding: 30px 24px;
      display: flex;
      flex-direction: column;
      z-index: 1100;
      backdrop-filter: blur(12px);
      background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=400&q=80');
      background-size: cover;
      background-position: center center;
      box-sizing: border-box;
    }

    /* Polprozorno belo prelivno ozadje za kontrast */
    #login-register-box {
      background: rgba(255 255 255 / 0.85);
      border-radius: 12px;
      padding: 20px 16px;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      color: #333;
    }

    #login-register-container.dark-mode #login-register-box {
      background: rgba(30 30 30 / 0.85);
      color: #eee;
      box-shadow: 0 0 15px rgba(255,255,255,0.1);
    }

    #login-register-form label {
      margin-top: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      user-select: none;
    }
    #login-register-form input[type="text"],
    #login-register-form input[type="password"],
    #login-register-form input[type="file"] {
      margin-top: 6px;
      padding: 8px 10px;
      font-size: 1rem;
      border: 2px solid #4facfe;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
      outline-offset: 2px;
      transition: border-color 0.25s ease;
    }
    #login-register-form input[type="text"]:focus,
    #login-register-form input[type="password"]:focus,
    #login-register-form input[type="file"]:focus {
      border-color: #00f2fe;
    }

    #login-register-form button {
      margin-top: 20px;
      padding: 12px 0;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow:
        0 4px 8px rgba(0, 142, 255, 0.7);
      transition: background 0.3s ease;
      user-select: none;
    }
    #login-register-form button:hover {
      background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
    }

    #toggle-login-register {
      margin-top: 14px;
      text-align: center;
      color: #007acc;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      text-decoration: underline;
    }
    #toggle-login-register:hover {
      color: #005fa3;
    }

    /* Glavni naslov z 3D efektom */
    header {
      text-align: center;
      margin: 20px 0 10px;
      user-select: none;
      z-index: 100;
    }

    /* Karte */
    #map {
      flex-grow: 1;
      z-index: 1;
    }

    /* Kontrole na vrhu desno */
    .controls {
      position: fixed;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 12px;
      z-index: 1200;
    }

    /* Gumbi z emoji + tooltip */
    .controls button {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1.4rem;
      cursor: pointer;
      padding: 10px 14px;
      box-shadow:
        0 3px 7px rgba(0, 140, 255, 0.7);
      transition: background 0.3s ease;
      position: relative;
      user-select: none;
    }
    .controls button[disabled] {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }
    .controls button:hover:not([disabled]) {
      background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
    }
    /* Tooltip */
    .controls button[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      white-space: nowrap;
      pointer-events: none;
      opacity: 1;
      z-index: 1300;
    }

    /* Panel s statistiko spodaj levo */
    #stats {
      position: fixed;
      bottom: 12px;
      left: 12px;
      background: linear-gradient(145deg, #4facfe, #00f2fe);
      border-radius: 20px;
      padding: 14px 20px;
      box-shadow:
        5px 5px 15px rgba(0, 120, 255, 0.6),
        inset -2px -2px 6px rgba(255 255 255 / 0.4),
        inset 2px 2px 6px rgba(0 0 0 / 0.2);
      color: white;
      font-weight: 700;
      font-size: 0.9rem;
      line-height: 1.4;
      user-select: none;
      min-width: 160px;
      z-index: 1100;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-shadow:
        0 0 4px rgba(0,0,0,0.25);
    }

    #stats div {
      margin-bottom: 6px;
    }

    /* Profil uporabnika spodaj desno */
    #profile {
      position: fixed;
      bottom: 12px;
      right: 12px;
      background: rgba(255 255 255 / 0.9);
      border-radius: 16px;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow:
        0 6px 18px rgba(0,0,0,0.2);
      user-select: none;
      z-index: 1100;
    }
    #profile img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #4facfe;
      box-shadow:
        0 0 10px #00f2fe;
    }
    #profile h2 {
      margin: 0;
      font-weight: 800;
      font-size: 1.3rem;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow:
        1px 1px 2px rgba(0,0,0,0.15);
    }

    /* Fokus za dostopnost */
    button:focus, input:focus {
      outline: 2px solid #00f2fe;
      outline-offset: 2px;
    }

  </style>
</head>
<body>
  <div id="login-register-container" style="display:flex;">
    <div id="login-register-box">
      <h3 id="form-title" class="fancy-3d-subtitle">Prijava</h3>
      <form id="login-register-form" autocomplete="off">
        <label for="username">Uporabni≈°ko ime</label>
        <input type="text" id="username" required autocomplete="username" />
        <label for="password">Geslo</label>
        <input type="password" id="password" required autocomplete="current-password" />
        <label for="avatar">Uporabni≈°ka slika</label>
        <input type="file" id="avatar" accept="image/*" />
        <button type="submit">Potrdi</button>
      </form>
      <div id="toggle-login-register" tabindex="0" role="button" aria-pressed="false">
        Nimate raƒçuna? Registrirajte se
      </div>
    </div>
  </div>

  <!-- Glavni naslov z 3D efektom -->
  <header>
    <h1 class="fancy-3d-text">GPS Sledilna Aplikacija</h1>
  </header>

  <!-- Kontrole za sledenje -->
  <div class="controls" role="region" aria-label="Kontrole sledenja">
    <button id="start-btn" title="Zaƒçni sledenje üèÅ" aria-label="Zaƒçni sledenje">üèÅ</button>
    <button id="stop-btn" disabled title="Ustavi sledenje üõë" aria-label="Ustavi sledenje">üõë</button>
    <button id="logout-btn" style="display:none;" title="Odjava üëã" aria-label="Odjava">üëã</button>
    <button id="toggle-theme-btn" title="Preklop med svetlim in temnim naƒçinom üåó" aria-label="Preklop teme">üåó</button>
  </div>

  <!-- Karta -->
  <div id="map" role="region" aria-label="Zemljevid GPS sledenja"></div>

  <!-- Statistika spodaj levo -->
  <div id="stats" aria-live="polite" aria-atomic="true" role="region" aria-label="Statistika poti">
    <div>Hitrost: <span id="speed">0</span> km/h</div>
    <div>Vi≈°ina: <span id="altitude">0</span> m</div>
    <div>Razdalja: <span id="distance">0</span> m</div>
    <div>ƒåas: <span id="time">0</span> s</div>
    <div>Povpreƒçna hitrost: <span id="avg-speed">0</span> km/h</div>
  </div>

  <!-- Profil uporabnika spodaj desno -->
  <div id="profile" style="display:none;" role="region" aria-label="Profil uporabnika">
    <img id="profile-avatar" src="" alt="Uporabni≈°ka slika" />
    <h2 id="profile-username" class="fancy-3d-subtitle"></h2>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  ></script>
  <script
    src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"
  ></script>

  <script>
    (() => {
      const startBtn = document.getElementById("start-btn");
      const stopBtn = document.getElementById("stop-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const toggleThemeBtn = document.getElementById("toggle-theme-btn");
      const loginContainer = document.getElementById("login-register-container");
      const loginForm = document.getElementById("login-register-form");
      const toggleLoginRegister = document.getElementById("toggle-login-register");
      const formTitle = document.getElementById("form-title");
      const profileDiv = document.getElementById("profile");
      const profileAvatar = document.getElementById("profile-avatar");
      const profileUsername = document.getElementById("profile-username");

      let map, markerGroup, pathLine;
      let watchId = null;
      let path = [];
      let startTime = null;
      let user = null;
      let darkMode = false;
      let registering = false;

      function initMap() {
        map = L.map("map").setView([46.056946, 14.505751], 13);
        L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 19,
            attribution:
              '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          }
        ).addTo(map);

        markerGroup = L.markerClusterGroup();
        map.addLayer(markerGroup);

        pathLine = L.polyline([], { color: "blue", weight: 5, opacity: 0.7 }).addTo(map);
      }

      function updateStats() {
        if (path.length < 2) return;
        let totalDistance = 0;
        for (let i = 1; i < path.length; i++) {
          totalDistance += path[i - 1].latLng.distanceTo(path[i].latLng);
        }

        const elapsedSeconds = (Date.now() - startTime) / 1000;
        const speed = path[path.length - 1].speed || 0;
        const altitude = path[path.length - 1].altitude || 0;
        const avgSpeed = totalDistance / elapsedSeconds * 3.6 || 0; // m/s -> km/h

        document.getElementById("speed").textContent = speed.toFixed(1);
        document.getElementById("altitude").textContent = altitude.toFixed(0);
        document.getElementById("distance").textContent = totalDistance.toFixed(0);
        document.getElementById("time").textContent = Math.floor(elapsedSeconds);
        document.getElementById("avg-speed").textContent = avgSpeed.toFixed(1);
      }

      function startTracking() {
        if (!navigator.geolocation) {
          alert("Va≈° brskalnik ne podpira geolokacije.");
          return;
        }

        path = [];
        startTime = Date.now();

        watchId = navigator.geolocation.watchPosition(
          (pos) => {
            const latLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
            const speed = pos.coords.speed ? pos.coords.speed * 3.6 : 0; // m/s to km/h
            const altitude = pos.coords.altitude || 0;

            path.push({ latLng, speed, altitude });

            markerGroup.clearLayers();
            markerGroup.addLayer(L.marker(latLng));
            pathLine.setLatLngs(path.map(p => p.latLng));
            map.panTo(latLng);

            updateStats();
          },
          (err) => {
            alert("Napaka pri pridobivanju lokacije: " + err.message);
            stopTracking();
          },
          {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 10000,
          }
        );

        startBtn.disabled = true;
        stopBtn.disabled = false;
      }

      function stopTracking() {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

      // Preklop med prijavo in registracijo
      toggleLoginRegister.addEventListener("click", () => {
        registering = !registering;
        if (registering) {
          formTitle.textContent = "Registracija";
          toggleLoginRegister.textContent = "Imate raƒçun? Prijavite se";
        } else {
          formTitle.textContent = "Prijava";
          toggleLoginRegister.textContent = "Nimate raƒçuna? Registrirajte se";
        }
      });

      // Omogoƒçi enter za toggle
      toggleLoginRegister.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          toggleLoginRegister.click();
        }
      });

      // Obdelava prijave / registracije
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = loginForm.username.value.trim();
        const password = loginForm.password.value;
        const avatarFile = loginForm.avatar.files[0];

        if (!username || !password) {
          alert("Prosim, vnesite uporabni≈°ko ime in geslo.");
          return;
        }

        // Preberi sliko kot data URL (ƒçe je nalo≈æena)
        let avatarDataUrl = null;
        if (avatarFile) {
          avatarDataUrl = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(avatarFile);
          });
        }

        // Lokalno shranjevanje (za demo namen)
        let users = JSON.parse(localStorage.getItem("gpsUsers") || "{}");

        if (registering) {
          if (users[username]) {
            alert("Uporabni≈°ko ime ≈æe obstaja. Izberite drugo.");
            return;
          }
          users[username] = {
            password,
            avatar: avatarDataUrl,
          };
          localStorage.setItem("gpsUsers", JSON.stringify(users));
          alert("Registracija uspe≈°na, sedaj se lahko prijavite.");
          registering = false;
          formTitle.textContent = "Prijava";
          toggleLoginRegister.textContent = "Nimate raƒçuna? Registrirajte se";
          loginForm.reset();
        } else {
          if (!users[username] || users[username].password !== password) {
            alert("Napaƒçno uporabni≈°ko ime ali geslo.");
            return;
          }
          user = {
            username,
            avatar: users[username].avatar,
          };
          loginContainer.style.display = "none";
          profileDiv.style.display = "flex";
          profileUsername.textContent = user.username;
          profileAvatar.src = user.avatar || "https://via.placeholder.com/60?text=Avatar";

          logoutBtn.style.display = "inline-block";
        }
      });

      // Odjava
      logoutBtn.addEventListener("click", () => {
        user = null;
        profileDiv.style.display = "none";
        logoutBtn.style.display = "none";
        loginContainer.style.display = "flex";
        loginForm.reset();
      });

      // Zaƒçetek/ustavitev sledenja
      startBtn.addEventListener("click", startTracking);
      stopBtn.addEventListener("click", stopTracking);

      // Preklop teme svetlo/temno
      toggleThemeBtn.addEventListener("click", () => {
        darkMode = !darkMode;
        document.body.classList.toggle("dark-mode", darkMode);
        loginContainer.classList.toggle("dark-mode", darkMode);
      });

      // Inicijalizacija zemljevida
      initMap();

    })();
  </script>
</body>
</html>
