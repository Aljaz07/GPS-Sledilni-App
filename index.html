<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Sledenje</title>
  <style>
    /* --- Osnovni reset in body --- */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121217;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    a {
      color: #66ccff;
      text-decoration: none;
    }

    /* --- Kontejner za login/registracijo --- */
    #login-container {
      width: 350px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 15px;
      background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80');
      background-size: cover;
      background-position: center;
      box-shadow:
        8px 8px 16px #0a0a22,
        -8px -8px 16px #22227a;
      backdrop-filter: brightness(0.6);
    }

    /* --- Zavihki --- */
    .tabs {
      display: flex;
      background: linear-gradient(145deg, #0f0f2f, #1a1a5a);
      border-radius: 12px;
      box-shadow: 6px 6px 12px #0a0a22, -6px -6px 12px #22227a;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .tab {
      flex: 1;
      padding: 12px;
      cursor: pointer;
      background: linear-gradient(145deg, #1a1a5a, #0f0f2f);
      color: white;
      font-weight: bold;
      border: none;
      outline: none;
      transition: background 0.3s ease;
      text-align: center;
      user-select: none;
    }
    .tab.active {
      background: linear-gradient(145deg, #3a3a8a, #1f1f6f);
      box-shadow: inset 4px 4px 8px #22226f, inset -4px -4px 8px #5050b0;
    }
    .tab:hover:not(.active) {
      background: linear-gradient(145deg, #15154d, #0d0d29);
    }

    .tab-content {
      display: none;
      color: white;
    }
    .tab-content.active {
      display: block;
    }

    /* --- Forme --- */
    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    input[type="text"],
    input[type="password"] {
      padding: 10px;
      border-radius: 8px;
      border: none;
      outline: none;
      font-size: 1em;
    }
    button {
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      background: linear-gradient(145deg, #1a1a5a, #0f0f2f);
      color: white;
      box-shadow: 4px 4px 8px #000044, -4px -4px 8px #222266;
      transition: background 0.3s ease;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background: linear-gradient(145deg, #30308a, #20206f);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* --- Tooltip --- */
    button[title] {
      position: relative;
    }
    button[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #222266cc;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.85em;
      white-space: nowrap;
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.3s ease;
      z-index: 10;
    }

    /* --- Glavni del strani (zemljevid + UI) --- */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background: #121217;
      overflow: hidden;
    }

    /* --- Zemljevid --- */
    #map {
      flex: 1;
    }

    /* --- Temni naƒçin --- */
    body.dark-mode {
      background: #0b0b14;
      color: #ddd;
    }
    body.dark-mode #login-container {
      filter: brightness(0.7);
    }

    /* --- Gumb za temo --- */
    #toggle-theme {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: linear-gradient(145deg, #222244, #111122);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      font-size: 1.4em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 3px 3px 7px #000000aa;
      user-select: none;
      border: none;
    }
    #toggle-theme:hover {
      background: linear-gradient(145deg, #444488, #222266);
    }

    /* --- Panel z osnovno statistiko (spodnji levi kot) --- */
    #stats-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: linear-gradient(145deg, #1a1a5a, #0f0f2f);
      padding: 12px 18px;
      border-radius: 15px;
      box-shadow: 6px 6px 12px #0a0a22, -6px -6px 12px #22227a;
      font-size: 0.9em;
      width: 210px;
      user-select: none;
      color: #aaddff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* --- Panel z lokacijo --- */
    #location-panel {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(145deg, #1a1a5a, #0f0f2f);
      padding: 14px 20px;
      border-radius: 15px;
      box-shadow: 6px 6px 12px #0a0a22, -6px -6px 12px #22227a;
      width: 270px;
      font-size: 0.9em;
      color: #aaddff;
      user-select: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* --- Avatar --- */
    #avatar {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid #66ccff;
      cursor: pointer;
      background-size: cover;
      background-position: center;
      box-shadow: 0 0 8px #66ccff;
      user-select: none;
    }
    #avatar:hover {
      box-shadow: 0 0 12px #99ddff;
    }

    /* --- Modal zgodovine vo≈æenj --- */
    #ride-history-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1200;
      padding: 10px;
    }
    #ride-history-modal.active {
      display: flex;
    }
    #ride-history-content {
      background: #121217;
      padding: 20px;
      border-radius: 15px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 15px #66ccffaa;
      color: #aaddff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #ride-history-close {
      cursor: pointer;
      color: #66ccff;
      font-size: 1.2em;
      font-weight: bold;
      float: right;
      user-select: none;
    }
    .ride-entry {
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid #445577;
    }
    .ride-entry h4 {
      margin: 0 0 4px 0;
      font-weight: bold;
      color: #99ccff;
    }
    .ride-stats {
      font-size: 0.85em;
      color: #aaccee;
    }
    .ride-map {
      height: 120px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #335577;
    }

    /* --- Gumbi z emoji in tooltip --- */
    button#startBtn::before {
      content: "‚ñ∂Ô∏è ";
    }
    button#stopBtn::before {
      content: "‚èπÔ∏è ";
    }
    button#toggle-theme::before {
      content: "üåô ";
    }

  </style>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
</head>
<body>
  <div id="login-container">
    <div class="tabs">
      <button id="tab-login" class="tab active" title="Prijavite se v sistem">Prijava</button>
      <button id="tab-register" class="tab" title="Ustvarite nov raƒçun">Registracija</button>
    </div>
    <div id="login-section" class="tab-content active">
      <form id="login-form">
        <input type="text" id="login-username" placeholder="Uporabni≈°ko ime" required />
        <input type="password" id="login-password" placeholder="Geslo" required />
        <button type="submit" title="Prijava">Prijava</button>
      </form>
    </div>
    <div id="register-section" class="tab-content">
      <form id="register-form">
        <input type="text" id="register-username" placeholder="Izberi uporabni≈°ko ime" required />
        <input type="password" id="register-password" placeholder="Izberi geslo" required />
        <button type="submit" title="Registracija">Registracija</button>
      </form>
    </div>
  </div>

  <div id="main" style="display:none;">
    <div id="avatar" title="Klikni za ogled zgodovine vo≈æenj"></div>
    <button id="toggle-theme" title="Preklopi temni naƒçin"></button>
    <div id="map"></div>

    <div id="stats-panel">
      <div>‚è± ƒåas: <span id="stat-time">0s</span></div>
      <div>üìè Razdalja: <span id="stat-distance">0 m</span></div>
      <div>üöÄ Povpreƒçna hitrost: <span id="stat-avgSpeed">0 km/h</span></div>
      <div>‚ö° Trenutna hitrost: <span id="stat-speed">0 km/h</span></div>
      <div>‚õ∞ Vi≈°ina: <span id="stat-altitude">-</span></div>
    </div>

    <div id="location-panel">
      <div><strong>Dr≈æava:</strong> <span id="country">-</span></div>
      <div><strong>Naslov:</strong> <span id="location">-</span></div>
      <div><strong>Raziskano:</strong> <span id="progress">0%</span></div>
    </div>

    <div style="position:absolute; bottom:90px; left:20px;">
      <button id="startBtn" title="Zaƒçni sledenje">Zaƒçni</button>
      <button id="stopBtn" title="Ustavi sledenje" disabled>Ustavi</button>
    </div>
  </div>

  <!-- Modal za zgodovino vo≈æenj -->
  <div id="ride-history-modal">
    <div id="ride-history-content">
      <div id="ride-history-close" title="Zapri">‚úñ</div>
      <h2>Zgodovina vo≈æenj</h2>
      <div id="ride-list"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Zavihki za login/registracijo ---
    const tabLogin = document.getElementById('tab-login');
    const tabRegister = document.getElementById('tab-register');
    const loginSection = document.getElementById('login-section');
    const registerSection = document.getElementById('register-section');

    tabLogin.addEventListener('click', () => {
      tabLogin.classList.add('active');
      tabRegister.classList.remove('active');
      loginSection.classList.add('active');
      registerSection.classList.remove('active');
    });

    tabRegister.addEventListener('click', () => {
      tabRegister.classList.add('active');
      tabLogin.classList.remove('active');
      registerSection.classList.add('active');
      loginSection.classList.remove('active');
    });

    // --- Globalne spremenljivke ---
    let map, pathLine, markerGroup, watchId = null, startTime = null;
    let path = [];
    let darkMode = false;
    let user = null;

    // --- Tile layer ---
    const lightTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OSM'
    });
    const darkTileLayer = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
      maxZoom: 19,
      attribution: '&copy; Stadia Maps'
    });

    // --- Prika≈æi glavni UI po loginu ---
    function showMainUI() {
      document.getElementById('login-container').style.display = 'none';
      document.getElementById('main').style.display = 'flex';
      initMap();
      loadUserData();
    }

    // --- Inicijalizacija mape ---
    function initMap() {
      if (map) return;
      map = L.map('map', { zoomControl: true });
      if (darkMode) {
        darkTileLayer.addTo(map);
      } else {
        lightTileLayer.addTo(map);
      }
      markerGroup = L.layerGroup().addTo(map);
    }

    // --- Posodobitev zemljevida glede na temo ---
    function updateMapTheme() {
      if (!map) return;
      if (darkMode) {
        map.removeLayer(lightTileLayer);
        darkTileLayer.addTo(map);
      } else {
        map.removeLayer(darkTileLayer);
        lightTileLayer.addTo(map);
      }
    }

    // --- Preklop teme ---
    document.getElementById('toggle-theme').addEventListener('click', () => {
      darkMode = !darkMode;
      document.body.classList.toggle('dark-mode', darkMode);
      updateMapTheme();
    });

    // --- Prijava in registracija (shranjevanje uporabnikov lokalno) ---
    function saveUser(username, password) {
      let users = JSON.parse(localStorage.getItem('users') || '{}');
      if (users[username]) return false; // ≈æe obstaja
      users[username] = { password, rides: [], avatar: null };
      localStorage.setItem('users', JSON.stringify(users));
      return true;
    }
    function getUser(username) {
      let users = JSON.parse(localStorage.getItem('users') || '{}');
      return users[username] || null;
    }
    function saveUserData(username, data) {
      let users = JSON.parse(localStorage.getItem('users') || '{}');
      if (!users[username]) return false;
      users[username] = {...users[username], ...data};
      localStorage.setItem('users', JSON.stringify(users));
      return true;
    }

    // --- Avatar ---
    const avatarEl = document.getElementById('avatar');
    function updateAvatar() {
      if (!user || !user.avatar) {
        avatarEl.style.backgroundImage = 'url(https://i.pravatar.cc/48?u=' + user.username + ')';
      } else {
        avatarEl.style.backgroundImage = `url(${user.avatar})`;
      }
    }

    // --- Login forma ---
    document.getElementById('login-form').addEventListener('submit', e => {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const foundUser = getUser(username);
      if (!foundUser) {
        alert('Uporabnik ne obstaja!');
        return;
      }
      if (foundUser.password !== password) {
        alert('Napaƒçno geslo!');
        return;
      }
      user = { username, ...foundUser };
      showMainUI();
      updateAvatar();
    });

    // --- Registracija forma ---
    document.getElementById('register-form').addEventListener('submit', e => {
      e.preventDefault();
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value.trim();
      if (saveUser(username, password)) {
        alert('Registracija uspe≈°na! Prosimo, prijavite se.');
        tabLogin.click();
      } else {
        alert('Uporabni≈°ko ime ≈æe obstaja.');
      }
    });

    // --- GPS sledenje ---
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');

    function formatTime(ms) {
      let totalSeconds = Math.floor(ms / 1000);
      let h = Math.floor(totalSeconds / 3600);
      let m = Math.floor((totalSeconds % 3600) / 60);
      let s = totalSeconds % 60;
      return (h > 0 ? h + 'h ' : '') + (m > 0 ? m + 'm ' : '') + s + 's';
    }

    let totalDistance = 0;

    startBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Va≈° brskalnik ne podpira geolokacije.');
        return;
      }
      path = [];
      totalDistance = 0;
      startTime = Date.now();
      updateStats(0,0,0,0);
      startBtn.disabled = true;
      stopBtn.disabled = false;
      if (pathLine) map.removeLayer(pathLine);
      markerGroup.clearLayers();

      watchId = navigator.geolocation.watchPosition(onPositionUpdate, onPositionError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
      });
    });

    stopBtn.addEventListener('click', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      saveRide();
      resetStats();
    });

    function onPositionUpdate(position) {
      const { latitude, longitude, altitude, speed } = position.coords;
      const timeElapsed = Date.now() - startTime;

      if (path.length > 0) {
        const lastPoint = path[path.length - 1];
        const dist = getDistanceFromLatLonInMeters(lastPoint.lat, lastPoint.lng, latitude, longitude);
        totalDistance += dist;
      }
      path.push({ lat: latitude, lng: longitude, altitude, speed, timestamp: Date.now() });

      updateStats(timeElapsed, totalDistance, speed, altitude);

      if (!pathLine) {
        pathLine = L.polyline(path, { color: 'cyan' }).addTo(map);
        map.fitBounds(pathLine.getBounds());
      } else {
        pathLine.setLatLngs(path);
        map.fitBounds(pathLine.getBounds());
      }

      markerGroup.clearLayers();
      L.circleMarker([latitude, longitude], { radius: 7, color: '#66ccff', fillColor: '#66ccff', fillOpacity: 0.7 }).addTo(markerGroup);
    }
    function onPositionError(error) {
      alert('Napaka pri pridobivanju lokacije: ' + error.message);
    }

    function updateStats(timeMs, distanceM, speedMps, altitude) {
      document.getElementById('stat-time').textContent = formatTime(timeMs);
      document.getElementById('stat-distance').textContent = distanceM.toFixed(0) + ' m';

      // Povpreƒçna hitrost v km/h
      let avgSpeed = timeMs > 0 ? (distanceM / (timeMs / 1000)) * 3.6 : 0;
      document.getElementById('stat-avgSpeed').textContent = avgSpeed.toFixed(1) + ' km/h';

      // Trenutna hitrost (ƒçe je null, 0)
      let speedKmh = speedMps !== null && speedMps !== undefined ? speedMps * 3.6 : 0;
      document.getElementById('stat-speed').textContent = speedKmh.toFixed(1) + ' km/h';

      // Vi≈°ina
      document.getElementById('stat-altitude').textContent = altitude !== null && altitude !== undefined ? altitude.toFixed(1) + ' m' : '-';

      // Posodobi lokacijo & dr≈æavo
      if (path.length > 0) {
        updateLocation(path[path.length-1].lat, path[path.length-1].lng);
      }
    }

    function resetStats() {
      document.getElementById('stat-time').textContent = '0s';
      document.getElementById('stat-distance').textContent = '0 m';
      document.getElementById('stat-avgSpeed').textContent = '0 km/h';
      document.getElementById('stat-speed').textContent = '0 km/h';
      document.getElementById('stat-altitude').textContent = '-';
      document.getElementById('country').textContent = '-';
      document.getElementById('location').textContent = '-';
      document.getElementById('progress').textContent = '0%';

      if (pathLine) {
        map.removeLayer(pathLine);
        pathLine = null;
      }
      markerGroup.clearLayers();
      path = [];
      totalDistance = 0;
    }

    // --- Funkcija za izraƒçun razdalje med koordinatami ---
    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // meters
      const œÜ1 = lat1 * Math.PI/180;
      const œÜ2 = lat2 * Math.PI/180;
      const ŒîœÜ = (lat2-lat1) * Math.PI/180;
      const ŒîŒª = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const d = R * c;
      return d;
    }

    // --- Reverse geocoding (nominatim) za prikaz lokacije in dr≈æave ---
    let lastCountry = '';
    async function updateLocation(lat, lng) {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
        const data = await res.json();
        if (!data.address) return;
        const country = data.address.country || '-';
        const city = data.address.city || data.address.town || data.address.village || data.address.hamlet || '-';
        const road = data.address.road || '';
        const houseNumber = data.address.house_number || '';
        const fullAddress = (road ? road + ' ' : '') + houseNumber + (houseNumber ? ', ' : '') + city;

        document.getElementById('country').textContent = country;
        document.getElementById('location').textContent = fullAddress || city;

        // ƒåe je dr≈æava spremenjena, resetiraj odstotek
        if (country !== lastCountry) {
          lastCountry = country;
          document.getElementById('progress').textContent = '0%';
          return;
        }

        // Izraƒçunaj % raziskane dr≈æave
        let bbox = data.boundingbox || null;
        if (bbox) {
          // Pribli≈æno: odstotek glede na to, koliko poti pokriva pribli≈æno
          // Tu je samo dummy vrednost glede na razdaljo
          let perc = Math.min(100, (totalDistance / 10000) * 100);
          document.getElementById('progress').textContent = perc.toFixed(1) + '%';
        }

      } catch (err) {
        console.warn('Napaka pri pridobivanju lokacije', err);
      }
    }

    // --- Shrani vo≈ænjo v uporabnikov profil ---
    function saveRide() {
      if (!user) return;
      if (path.length < 2) return;

      const ride = {
        id: Date.now(),
        path,
        startTime,
        endTime: Date.now(),
        distance: totalDistance,
        duration: Date.now() - startTime,
      };
      user.rides.push(ride);
      saveUserData(user.username, { rides: user.rides });
      alert('Vo≈ænja shranjena.');
    }

    // --- Nalo≈æi uporabni≈°ke podatke ---
    function loadUserData() {
      if (!user) return;
      const storedUser = getUser(user.username);
      if (storedUser) {
        user.rides = storedUser.rides || [];
        user.avatar = storedUser.avatar || null;
        updateAvatar();
      }
    }

    // --- Avatar klik: odpri zgodovino vo≈æenj ---
    avatarEl.addEventListener('click', () => {
      if (!user || !user.rides.length) {
        alert('Ni zgodovine vo≈æenj.');
        return;
      }
      showRideHistory();
    });

    // --- Modal zgodovine vo≈æenj ---
    const modal = document.getElementById('ride-history-modal');
    const closeModalBtn = document.getElementById('close-modal');
    closeModalBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });
    window.addEventListener('click', e => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });

    function showRideHistory() {
      const list = document.getElementById('ride-list');
      list.innerHTML = '';
      user.rides.forEach(ride => {
        const item = document.createElement('li');
        const date = new Date(ride.startTime);
        item.textContent = `${date.toLocaleString()} ‚Äî Razdalja: ${ride.distance.toFixed(0)} m, ƒåas: ${formatTime(ride.duration)}`;
        item.style.cursor = 'pointer';
        item.addEventListener('click', () => {
          showRideOnMap(ride);
          modal.style.display = 'none';
        });
        list.appendChild(item);
      });
      modal.style.display = 'flex';
    }

    function showRideOnMap(ride) {
      if (!map) return;
      if (pathLine) map.removeLayer(pathLine);
      markerGroup.clearLayers();
      pathLine = L.polyline(ride.path, { color: 'orange' }).addTo(map);
      map.fitBounds(pathLine.getBounds());
    }

    // --- Upload avatar ---
    const avatarInput = document.getElementById('avatar-input');
    avatarInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        user.avatar = event.target.result;
        saveUserData(user.username, { avatar: user.avatar });
        updateAvatar();
      };
      reader.readAsDataURL(file);
    });

  </script>

</body>
</html>

