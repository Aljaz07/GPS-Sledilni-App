<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GPS Sledilna Aplikacija – Več uporabnikov in statistika</title>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>

<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #fff;
    transition: background 0.3s ease;
  }
  body.dark-mode {
    background: #121212;
    color: #eee;
  }
  #map {
    height: 70vh;
    width: 100%;
  }
  .controls {
    padding: 10px;
    max-width: 420px;
    margin: 0 auto 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  button {
    background: linear-gradient(145deg, #e0e0e0, #bababa);
    border: none;
    border-radius: 10px;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    cursor: pointer;
    box-shadow: 5px 5px 8px #a3a3a3,
      -5px -5px 8px #ffffff;
    transition: all 0.3s ease;
    flex: 1 1 45%;
    min-width: 120px;
    text-align: center;
    user-select: none;
  }
  button:hover {
    box-shadow: inset 5px 5px 8px #a3a3a3,
      inset -5px -5px 8px #ffffff;
    color: #000;
  }
  body.dark-mode button {
    background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
    color: #ccc;
    box-shadow: 5px 5px 8px #0f0f0f,
      -5px -5px 8px #3a3a3a;
  }
  body.dark-mode button:hover {
    box-shadow: inset 5px 5px 8px #0f0f0f,
      inset -5px -5px 8px #3a3a3a;
    color: #fff;
  }
  #stats {
    max-width: 420px;
    margin: 0 auto 20px;
    background: #f0f0f0;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
  }
  body.dark-mode #stats {
    background: #222;
    color: #eee;
    box-shadow: 0 6px 12px rgba(0,0,0,0.8);
  }
  #stats div {
    margin-bottom: 6px;
    font-weight: 600;
  }
  #profile {
    max-width: 420px;
    margin: 20px auto;
    text-align: center;
  }
  #profile img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 10px;
  }
  #profile h2 {
    margin: 0 0 10px 0;
  }

  /* Prijava / registracija */
  #login-register-container {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  #login-register-box {
    background: #fff;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    width: 320px;
  }
  body.dark-mode #login-register-box {
    background: #333;
    color: #eee;
  }
  #login-register-box h3 {
    text-align: center;
    margin-bottom: 20px;
  }
  #login-register-box label {
    display: block;
    margin-top: 10px;
    font-weight: 600;
  }
  #login-register-box input[type="text"],
  #login-register-box input[type="password"],
  #login-register-box input[type="file"] {
    width: 100%;
    padding: 8px;
    margin-top: 6px;
    border-radius: 8px;
    border: 1px solid #aaa;
  }
  #login-register-box input[type="file"] {
    padding: 3px;
  }
  #login-register-box button {
    margin-top: 20px;
    width: 100%;
  }
  #toggle-login-register {
    margin-top: 12px;
    text-align: center;
    color: #0066cc;
    cursor: pointer;
    user-select: none;
  }
  #toggle-login-register:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<!-- Prijava / registracija -->
<div id="login-register-container">
  <div id="login-register-box">
    <h3 id="form-title">Prijava</h3>
    <label for="username-input">Uporabniško ime</label>
    <input type="text" id="username-input" placeholder="Vnesi uporabniško ime" />
    <label for="password-input">Geslo</label>
    <input type="password" id="password-input" placeholder="Vnesi geslo" />
    <div id="register-extra" style="display:none;">
      <label for="avatar-input">Izberi avatar (sliko)</label>
      <input type="file" id="avatar-input" accept="image/*" />
    </div>
    <button id="login-register-btn">Prijava</button>
    <div id="toggle-login-register">Registracija</div>
    <div id="login-message" style="color:red; margin-top:8px;"></div>
  </div>
</div>

<!-- Profil in statistika -->
<div id="profile" style="display:none;">
  <img id="profile-avatar" src="" alt="Avatar" />
  <h2 id="profile-username"></h2>
  <button onclick="logout()">Odjava</button>
</div>

<div class="controls" style="display:none;">
  <button onclick="startTracking()">Začni sledenje</button>
  <button onclick="stopTracking()">Ustavi</button>
  <button onclick="clearTrack()">Počisti</button>
  <button onclick="returnToCurrentLocation()">Moja lokacija</button>
  <button onclick="toggleDarkMode()">Preklopi temni način</button>
</div>

<div id="stats" style="display:none;">
  <div>Razdalja: <span id="stat-distance">0</span> km</div>
  <div>Čas sledenja: <span id="stat-time">00:00:00</span></div>
  <div>Povprečna hitrost: <span id="stat-speed">0</span> km/h</div>
  <div>Trenutna hitrost: <span id="stat-current-speed">-</span> km/h</div>
  <div>Višina: <span id="stat-altitude">-</span> m</div>
</div>

<div id="map" style="display:none;"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
  (() => {
    // === SPREMENLJIVKE ===
    let map, lightModeLayer, darkModeLayer, userMarker, avatarMarker;
    let path = [];
    let polyline;
    let watchId = null;
    let startTime = null;
    let elapsedSeconds = 0;
    let timerInterval = null;

    let currentUser = null; // Objekt trenutnega uporabnika {username, password, avatarDataURL, paths: [ ... ]}

    // === PRIJAVA IN REGISTRACIJA ===
    const loginContainer = document.getElementById("login-register-container");
    const formTitle = document.getElementById("form-title");
    const usernameInput = document.getElementById("username-input");
    const passwordInput = document.getElementById("password-input");
    const avatarInput = document.getElementById("avatar-input");
    const registerExtra = document.getElementById("register-extra");
    const loginRegisterBtn = document.getElementById("login-register-btn");
    const toggleLoginRegister = document.getElementById("toggle-login-register");
    const loginMessage = document.getElementById("login-message");

    let isLoginMode = true;

    toggleLoginRegister.addEventListener("click", () => {
      isLoginMode = !isLoginMode;
      loginMessage.textContent = "";
      if (isLoginMode) {
        formTitle.textContent = "Prijava";
        loginRegisterBtn.textContent = "Prijava";
        registerExtra.style.display = "none";
        toggleLoginRegister.textContent = "Registracija";
      } else {
        formTitle.textContent = "Registracija";
        loginRegisterBtn.textContent = "Registriraj se";
        registerExtra.style.display = "block";
        toggleLoginRegister.textContent = "Prijava";
      }
    });

    // Pomaga shraniti uporabnike v localStorage
    function loadUsers() {
      return JSON.parse(localStorage.getItem("users") || "{}");
    }
    function saveUsers(users) {
      localStorage.setItem("users", JSON.stringify(users));
    }

    loginRegisterBtn.addEventListener("click", () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();

      if (!username || !password) {
        loginMessage.textContent = "Vnesi uporabniško ime in geslo.";
        return;
      }

      const users = loadUsers();

      if (isLoginMode) {
        // Prijava
        if (!users[username]) {
          loginMessage.textContent = "Uporabnik ne obstaja.";
          return;
        }
        if (users[username].password !== password) {
          loginMessage.textContent = "Napačno geslo.";
          return;
        }
        currentUser = users[username];
        currentUser.username = username;
        loginContainer.style.display = "none";
        initApp();
      } else {
        // Registracija
        if (users[username]) {
          loginMessage.textContent = "Uporabniško ime je zasedeno.";
          return;
        }
        // Preberi avatar sliko (če je)
        const file = avatarInput.files[0];
        if (!file) {
          loginMessage.textContent = "Izberi avatar sliko.";
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          users[username] = {
            password: password,
            avatarDataURL: reader.result,
            paths: []
          };
          saveUsers(users);
          loginMessage.style.color = "green";
          loginMessage.textContent = "Registracija uspešna! Prosimo, prijavi se.";
          // Preklopi nazaj na prijavo
          isLoginMode = true;
          formTitle.textContent = "Prijava";
          loginRegisterBtn.textContent = "Prijava";
          registerExtra.style.display = "none";
          toggleLoginRegister.textContent = "Registracija";
        };
        reader.readAsDataURL(file);
      }
    });

    // === APLIKACIJA ===

    function initApp() {
      document.querySelector(".controls").style.display = "flex";
      document.getElementById("stats").style.display = "block";
      document.getElementById("map").style.display = "block";
      document.getElementById("profile").style.display = "block";

      // Profil
      document.getElementById("profile-avatar").src = currentUser.avatarDataURL;
      document.getElementById("profile-username").textContent = currentUser.username;

      // Inicializacija zemljevida
      map = L.map("map", {
        zoomControl: false
      }).setView([46.056946, 14.505751], 13);

      lightModeLayer = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution:
            '© <a href="https://openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors'
        }
      ).addTo(map);

      darkModeLayer = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          maxZoom: 19,
          attribution:
            '© <a href="https://carto.com/attributions" target="_blank">Carto</a>'
        }
      );

      // Uporabnik marker + avatar
      const avatarIcon = L.divIcon({
        html: `<img src="${currentUser.avatarDataURL}" alt="avatar" style="width:32px;height:32px;border-radius:50%;border:2px solid #444">`,
        iconSize: [36, 36],
        className: ""
      });

      userMarker = L.marker([46.056946, 14.505751], {
        icon: avatarIcon
      }).addTo(map);

      // Polyline za pot
      polyline = L.polyline([], { color: "blue" }).addTo(map);

      // Če je uporabnik že imel poti, jih naložimo in prikažemo (po želji)
      if (currentUser.paths && currentUser.paths.length > 0) {
        currentUser.paths.forEach(pathData => {
          L.polyline(pathData, { color: "#888" }).addTo(map);
        });
      }

      // Začetni reset statistike
      resetStats();

      // Temni način iz lokalne shrambe
      if (localStorage.getItem("darkMode") === "true") {
        enableDarkMode(true);
      }
    }

    // === SPLETNI GEO LOKACIJSKI DEL ===

    function startTracking() {
      if (watchId !== null) {
        return; // že teče
      }
      path = [];
      polyline.setLatLngs([]);
      startTime = Date.now();
      elapsedSeconds = 0;
      updateStats();
      timerInterval = setInterval(() => {
        elapsedSeconds++;
        updateStats();
      }, 1000);

      watchId = navigator.geolocation.watchPosition(
        position => {
          const { latitude, longitude, speed, altitude } = position.coords;
          const latlng = [latitude, longitude];
          path.push(latlng);

          polyline.addLatLng(latlng);
          map.panTo(latlng);

          // Posodobi marker
          userMarker.setLatLng(latlng);

          // Posodobi statistiko
          updateStats(speed, altitude);
        },
        error => {
          alert("Napaka pri pridobivanju lokacije: " + error.message);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 10000
        }
      );
    }

    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      // Shrani pot v uporabnikov profil
      if (path.length > 1) {
        if (!currentUser.paths) currentUser.paths = [];
        currentUser.paths.push(path);
        saveCurrentUser();
      }
      alert("Sledenje je ustavljeno in pot je shranjena.");
    }

    function clearTrack() {
      path = [];
      polyline.setLatLngs([]);
      resetStats();
    }

    function returnToCurrentLocation() {
      if (!userMarker) return;
      map.panTo(userMarker.getLatLng());
      map.setZoom(17);
    }

    // === STATISTIKA ===
    let totalDistance = 0;
    let avgSpeed = 0;

    function resetStats() {
      totalDistance = 0;
      avgSpeed = 0;
      elapsedSeconds = 0;
      updateStats(0, 0);
    }

    function updateStats(currentSpeed = 0, currentAltitude = null) {
      if (path.length > 1) {
        totalDistance = 0;
        for (let i = 1; i < path.length; i++) {
          totalDistance += turf.distance(path[i - 1], path[i]);
        }
      } else {
        totalDistance = 0;
      }
      // Povprečna hitrost (km/h)
      avgSpeed = elapsedSeconds > 0 ? (totalDistance / (elapsedSeconds / 3600)) : 0;

      // Prikaz statistike
      document.getElementById("stat-distance").textContent = totalDistance.toFixed(2);
      document.getElementById("stat-time").textContent = formatTime(elapsedSeconds);
      document.getElementById("stat-speed").textContent = avgSpeed.toFixed(2);
      document.getElementById("stat-current-speed").textContent = currentSpeed ? (currentSpeed * 3.6).toFixed(2) : "-"; // m/s v km/h
      document.getElementById("stat-altitude").textContent = currentAltitude !== null ? currentAltitude.toFixed(0) : "-";
    }

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return [h, m, s].map(v => String(v).padStart(2, "0")).join(":");
    }

    // === SHRANJEVANJE UPORABNIKA V localStorage ===
    function saveCurrentUser() {
      if (!currentUser || !currentUser.username) return;
      const users = loadUsers();
      users[currentUser.username] = currentUser;
      saveUsers(users);
    }

    // === ODJAVA ===
    function logout() {
      currentUser = null;
      loginContainer.style.display = "flex";
      document.querySelector(".controls").style.display = "none";
      document.getElementById("stats").style.display = "none";
      document.getElementById("map").style.display = "none";
      document.getElementById("profile").style.display = "none";

      usernameInput.value = "";
      passwordInput.value = "";
      avatarInput.value = "";
      loginMessage.textContent = "";
      path = [];
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      if (polyline) polyline.setLatLngs([]);
      map = null;
    }

    // === TEMNI NAČIN ===
    function enableDarkMode(enabled) {
      if (enabled) {
        document.body.classList.add("dark-mode");
        if (map) {
          map.removeLayer(lightModeLayer);
          darkModeLayer.addTo(map);
        }
        localStorage.setItem("darkMode", "true");
      } else {
        document.body.classList.remove("dark-mode");
        if (map) {
          map.removeLayer(darkModeLayer);
          lightModeLayer.addTo(map);
        }
        localStorage.setItem("darkMode", "false");
      }
    }

    function toggleDarkMode() {
      enableDarkMode(!document.body.classList.contains("dark-mode"));
    }

    window.toggleDarkMode = toggleDarkMode;
    window.startTracking = startTracking;
    window.stopTracking = stopTracking;
    window.clearTrack = clearTrack;
    window.returnToCurrentLocation = returnToCurrentLocation;
    window.logout = logout;

  })();
</script>

</body>
</html>
